<!doctype html>
<html>

<head>
    <title>RPS Game</title>

    <link href="main.css" rel="stylesheet" >

    <!-- BOOTSTRAP -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

</head>

<body>
    
    <div class="main row fullscreen no-margin">
        <div class="col-sm-12 col-md-6 col-lg-6 no-padding red-team">
            <div id="redlives"></div>
            <h1 id="votingheader" style="display: none">You can now vote for your team!</h1>
            <div class="timer"><h2 id="timer"></h2></div>
            <ul id="messages"></ul>
            <div id="reditemdisplay"></div>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-6 no-padding blue-team">
            <div id="bluelives"></div>
            <div id="blueitemdisplay"></div>
        </div>
    </div>


    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
        $(function () {
            RedLives = 3;
            BlueLives = 3;

            var socket = io('', {
                query: 'name=game'
            });

            // Start GameLoop
            GameLoop();

            
            $('#getresult').click(function(){
                socket.emit('game result');
            });

            // Game returns round result
            socket.on('game get result', function(result){
                if (result.team == null || result.team == -1){
                    window.location.reload();
                } else {
                    RoundWon(result);
                }
            });


            //=== GameFunctions
            // Reset Round
            function ResetRound(){
                $('#reditemdisplay').text("");
                $('#blueitemdisplay').text("");
                socket.emit('game reset round');
                GameLoop();
            }

            function CountDown(amountofseconds=10, oncomplete){
                var counter = amountofseconds + 1;
                var interval = setInterval(function() {
                    counter--;
                    $('#timer').text(counter);
                    if (counter == 0) {
                        // Display a login box
                        clearInterval(interval);
                        $('#timer').text('');
                        oncomplete();
                    }
                }, 1000);
            }

            function StartRound(){
                $('#votingheader').show();
                socket.emit('showplayervoting');
                // Start CountDown
                CountDown(15, function() {
                    // Run when Countdown is at zero
                    $('#votingheader').hide();
                    socket.emit('hideplayervoting');
                    // Get Result back
                    socket.emit('game result');
                });
            }

            function GameLoop(){
                if (RedLives > 0 && BlueLives > 0){
                    StartRound()
                } else if (RedLives == 0){
                    GameOver('red');
                } else {
                    GameOver('blue');
                }
            }

            function RoundWon(result){
                if (result.team == 0){
                    // Draw
                    $('#messages').append($('<li>').text("Draw"));
                } else if (result.team == 1){
                    // Red Won
                    BlueLives--;
                    $('#messages').append($('<li>').text("Red Won "));
                } else {
                    // Blue Won
                    RedLives--;
                    $('#messages').append($('<li>').text("Blue Won "));
                }

                DisplayTeamItems(result);

                UpdateLives();

                // After 10 seconds reset game to next round
                setTimeout(function(){
                    ResetRound();
                }, 10000);

            }

            // Display chosen item for both teams.
            function DisplayTeamItems(result){
                // result.itemRed -> type & amount
                // result.itemBlue -> type & amount
                $('#reditemdisplay').text(result.itemRed.type);
                $('#blueitemdisplay').text(result.itemBlue.type);
            }

            // Update Lives display.
            function UpdateLives(){
                $('#redlives').text(RedLives);
                $('#bluelives').text(BlueLives);
            }

            function GameOver(team){
                // A team has won.
                $('#messages').append($('<li>').text(`Team ${team} Won!`));
                
                // Restart game after 10 seconds
                setTimeout(() => {
                    window.location.reload();
                }, 10000);
            }

        });

    </script>
</body>

</html>